# 要件定義書

## はじめに

家庭内向けの生活費可視化システムは、月次の予算と実績を収集・集計し、リビングで常時表示することで、家計の状態を受動的に確認できるようにするシステムです。このシステムの目的は、振り返りではなく「今の状態が常に見える」ことで消費抑制（行動変容）につなげることです。

システムはRaspberry Pi上のk3sクラスターで動作し、Backend（FastAPI）とFrontend（Streamlit）の2コンポーネントで構成されます。データはSQLiteで永続化し、将来的にPostgreSQLへの移行を可能にします。

## 要件

### 要件1: 予算管理

**ユーザーストーリー:** 家計管理者として、月別・カテゴリ別の予算を登録・更新したい。これにより、計画的な支出管理ができるようになる。

#### 受け入れ基準

1. WHEN ユーザーが月（YYYY-MM形式）、カテゴリ、金額（円）を入力して予算を登録する THEN システムは予算データを保存する
2. WHEN 同じ月・カテゴリの組み合わせで予算を登録する THEN システムは既存の予算を更新する
3. WHEN 予算が登録・更新される THEN ダッシュボードの予算合計に即座に反映される
4. IF 予算金額が0以上の整数でない THEN システムはエラーメッセージを表示し、登録を拒否する

### 要件2: 支出実績の記録

**ユーザーストーリー:** 家計管理者として、日々の支出をスマホやPCから簡単に記録したい。これにより、入力の負荷を最小限にして継続的な記録ができる。

#### 受け入れ基準

1. WHEN ユーザーが日付（YYYY-MM-DD形式）、カテゴリ、金額（円）を入力して支出を登録する THEN システムは支出データを保存する
2. WHEN 支出を登録する際に任意でメモを追加する THEN システムはメモも含めて保存する
3. WHEN 支出が登録される THEN ダッシュボードの使用合計と残額に即座に反映される
4. IF 支出金額が0以上の整数でない THEN システムはエラーメッセージを表示し、登録を拒否する
5. WHEN 支出を登録する THEN システムは作成日時（created_at）を自動的に記録する
6. IF 日付がAsia/Tokyoタイムゾーンで処理されない THEN システムは正しいタイムゾーンで日付を保存する

### 要件3: 月次集計の表示

**ユーザーストーリー:** 家族として、リビングのダッシュボードで今月の予算・支出・残額を一目で確認したい。これにより、現在の家計状態を受動的に把握できる。

#### 受け入れ基準

1. WHEN ダッシュボードを表示する THEN 今月の予算合計が表示される
2. WHEN ダッシュボードを表示する THEN 今月の使用合計（支出合計）が表示される
3. WHEN ダッシュボードを表示する THEN 残額（予算合計 - 使用合計）が表示される
4. WHEN ダッシュボードを表示する THEN 月末までの残日数が表示される
5. WHEN ダッシュボードを表示する THEN 1日あたり使える残予算（残額 / 残日数）が表示される
6. IF 残日数が0の場合 THEN 1日あたり残予算は「-」または適切なメッセージを表示する
7. WHEN ダッシュボードを表示する THEN 使用率（使用合計 / 予算合計 × 100）が表示される

### 要件4: 状態表示と行動変容

**ユーザーストーリー:** 家族として、予算の使用状況に応じた警告を視覚的に確認したい。これにより、使いすぎの兆候を早期に察知し、消費を抑制できる。

#### 受け入れ基準

1. WHEN 使用率が70%未満の場合 THEN システムは「OK」状態を緑色で表示する
2. WHEN 使用率が70%以上90%未満の場合 THEN システムは「WARN」状態を黄色で表示する
3. WHEN 使用率が90%以上の場合 THEN システムは「DANGER」状態を赤色で表示する
4. WHEN 状態が表示される THEN 大きい文字で一目で理解できるように表示される
5. WHEN WARN状態の場合 THEN 適切な警告メッセージが表示される
6. WHEN DANGER状態の場合 THEN 強い警告メッセージが表示される

### 要件5: ダッシュボードの自動更新

**ユーザーストーリー:** 家族として、ダッシュボードが常に最新の情報を表示してほしい。これにより、手動で更新することなく現在の状態を把握できる。

#### 受け入れ基準

1. WHEN ダッシュボードが表示されている THEN 30秒ごとに自動的にデータを再取得して更新する
2. WHEN 自動更新が実行される THEN ユーザーの操作を妨げない
3. WHEN ダッシュボードがKioskモードで表示される THEN レイアウトが崩れずに表示される
4. WHEN ダッシュボードがHDMI接続のディスプレイで表示される THEN 適切な解像度で表示される

### 要件6: Backend API

**ユーザーストーリー:** システム開発者として、FastAPIで実装されたRESTful APIを通じてデータを操作したい。これにより、フロントエンドとバックエンドを分離し、将来的な拡張性を確保できる。

#### 受け入れ基準

1. WHEN APIが起動する THEN ヘルスチェックエンドポイント（/health）が200を返す
2. WHEN 予算の登録・更新APIを呼び出す THEN データベースに予算が保存される
3. WHEN 支出の登録APIを呼び出す THEN データベースに支出が保存される
4. WHEN 月次集計APIを呼び出す THEN 予算合計、使用合計、残額、残日数、1日あたり残予算、使用率、状態を含むJSONを返す
5. WHEN APIでエラーが発生する THEN 適切なHTTPステータスコードとエラーメッセージを返す
6. WHEN APIが起動する THEN 標準出力にログを出力する

### 要件7: データ永続化

**ユーザーストーリー:** システム管理者として、Podが再起動してもデータが失われないようにしたい。これにより、安定した運用ができる。

#### 受け入れ基準

1. WHEN システムがk8s上にデプロイされる THEN SQLiteデータベースはPVCに保存される
2. WHEN Podが再起動する THEN 既存のデータが保持される
3. WHEN データベースファイルが作成される THEN 適切なスキーマ（Budgets, Expenses）が初期化される
4. IF データベースが存在しない THEN システムは自動的に初期化する
5. WHEN データアクセス層を実装する THEN 将来的にPostgreSQLへ移行可能な設計にする

### 要件8: k8sデプロイメント

**ユーザーストーリー:** システム管理者として、Helmを使用してk3sクラスターにシステムをデプロイしたい。これにより、GitOpsによる自動デプロイと管理ができる。

#### 受け入れ基準

1. WHEN Helmチャートを適用する THEN Backend（FastAPI）とFrontend（Streamlit）がDeploymentとして起動する
2. WHEN Helmチャートを適用する THEN PVCが作成され、SQLiteデータベース用にマウントされる
3. WHEN Podが起動する THEN livenessProbeとreadinessProbeが設定される
4. WHEN Podが異常終了する THEN k8sが自動的に再起動する
5. WHEN Ingressを設定する THEN 家庭LAN内から http://home-finance.local/ でUIにアクセスできる
6. WHEN Argo CDを使用する THEN Gitリポジトリの変更が自動的にデプロイされる
7. WHEN ログを確認する THEN kubectl logs でアプリケーションログを確認できる

### 要件9: UI入力フォーム

**ユーザーストーリー:** 家計管理者として、スマホやPCから簡単に予算と支出を入力したい。これにより、外出先や家の中から手軽に記録できる。

#### 受け入れ基準

1. WHEN 支出追加フォームを表示する THEN カテゴリ、金額、日付の入力欄が表示される
2. WHEN 支出追加フォームを表示する THEN 任意でメモを入力できる欄が表示される
3. WHEN 支出を送信する THEN バリデーションが実行され、エラーがあれば表示される
4. WHEN 支出が正常に登録される THEN 成功メッセージが表示される
5. WHEN 予算設定フォームを表示する THEN 月、カテゴリ、金額の入力欄が表示される
6. WHEN 予算を送信する THEN バリデーションが実行され、エラーがあれば表示される
7. WHEN 予算が正常に登録される THEN 成功メッセージが表示される
8. WHEN フォームをスマホで表示する THEN レスポンシブデザインで適切に表示される

### 要件10: セキュリティとプライバシー

**ユーザーストーリー:** 家族として、家計データが家庭内LANで完結し、外部に漏れないようにしたい。これにより、プライバシーを保護できる。

#### 受け入れ基準

1. WHEN システムをデプロイする THEN インターネットに公開されない
2. WHEN システムをデプロイする THEN 家庭内LANからのみアクセス可能である
3. WHEN 外部SaaS連携を検討する THEN MVPでは実装しない
4. IF 将来的に認証が必要になる THEN k8s Secretで認証情報を管理できる設計にする
5. WHEN データを保存する THEN 暗号化は初期実装では不要だが、将来的に追加可能な設計にする

### 要件11: 将来拡張への対応

**ユーザーストーリー:** システム開発者として、将来的な機能拡張を見据えた設計にしたい。これにより、段階的に機能を追加できる。

#### 受け入れ基準

1. WHEN データアクセス層を実装する THEN SQLiteからPostgreSQLへの移行が容易な抽象化を行う
2. WHEN カテゴリを実装する THEN 将来的に編集可能にできる設計にする
3. WHEN システムを設計する THEN 複数ユーザー・権限管理を将来追加できる構造にする
4. WHEN UIを設計する THEN 電子ペーパー表示への対応を考慮する
5. WHEN 通知機能を検討する THEN LINE/メール等の通知を将来追加できる設計にする
6. WHEN データ取り込みを検討する THEN CSV/OFX/API連携を将来追加できる設計にする
